// SPDX-License-Identifier: GPL-2.0-only
/*
 * Chronos Multi-Camera System Device Tree Overlay
 * Target: NVIDIA Jetson Orin NX
 *
 * This overlay configures:
 * - CSI port for 2-lane MIPI input from Chronos FPGA
 * - Virtual channel demultiplexing for 4 cameras
 * - I2C bus for FPGA and camera control
 * - SPI bus for IMU
 * - GPIO for trigger signals
 */

/dts-v1/;
/plugin/;

#include <dt-bindings/gpio/tegra234-gpio.h>
#include <dt-bindings/clock/tegra234-clock.h>

/ {
    compatible = "nvidia,p3768-0000+p3767-0000";  /* Orin NX */
    
    fragment@0 {
        target-path = "/";
        __overlay__ {
            chronos_clk: chronos-clock {
                compatible = "fixed-clock";
                #clock-cells = <0>;
                clock-frequency = <24000000>;
                clock-output-names = "chronos_mclk";
            };
        };
    };
    
    /* I2C bus for camera and FPGA control */
    fragment@1 {
        target = <&i2c2>;
        __overlay__ {
            #address-cells = <1>;
            #size-cells = <0>;
            status = "okay";
            clock-frequency = <400000>;
            
            /* Chronos FPGA configuration interface */
            chronos_fpga: chronos-fpga@3c {
                compatible = "chronos,fpga-ctrl";
                reg = <0x3c>;
                status = "okay";
            };
            
            /* OV9281 Camera 0 */
            ov9281_a: ov9281@60 {
                compatible = "ovti,ov9281";
                reg = <0x60>;
                
                clocks = <&chronos_clk>;
                clock-names = "xvclk";
                clock-frequency = <24000000>;
                
                avdd-supply = <&vdd_cam_2v8>;
                dovdd-supply = <&vdd_cam_1v8>;
                dvdd-supply = <&vdd_cam_1v2>;
                
                reset-gpios = <&gpio TEGRA234_MAIN_GPIO(H, 3) GPIO_ACTIVE_LOW>;
                
                status = "okay";
                
                port {
                    ov9281_a_out: endpoint {
                        remote-endpoint = <&chronos_csi_in>;
                        clock-lanes = <0>;
                        data-lanes = <1 2>;
                        link-frequencies = /bits/ 64 <400000000>;
                    };
                };
            };
            
            /* Additional OV9281 cameras share same I2C bus but different addresses */
            /* In practice, all sensors are configured through the FPGA */
        };
    };
    
    /* SPI bus for IMU */
    fragment@2 {
        target = <&spi0>;
        __overlay__ {
            #address-cells = <1>;
            #size-cells = <0>;
            status = "okay";
            
            /* BMI088 IMU */
            bmi088@0 {
                compatible = "bosch,bmi088";
                reg = <0>;
                spi-max-frequency = <10000000>;
                
                /* Interrupt for sync trigger */
                interrupt-parent = <&gpio>;
                interrupts = <TEGRA234_MAIN_GPIO(H, 6) IRQ_TYPE_EDGE_RISING>;
                
                /* Accelerometer and gyroscope settings */
                mount-matrix = "1", "0", "0",
                               "0", "1", "0",
                               "0", "0", "1";
                
                status = "okay";
            };
        };
    };
    
    /* CSI port configuration */
    fragment@3 {
        target = <&csi>;
        __overlay__ {
            status = "okay";
            
            channel@0 {
                reg = <0>;
                status = "okay";
                
                ports {
                    #address-cells = <1>;
                    #size-cells = <0>;
                    
                    port@0 {
                        reg = <0>;
                        chronos_csi_in: endpoint {
                            status = "okay";
                            port-index = <0>;
                            bus-width = <2>;
                            remote-endpoint = <&chronos_fpga_out>;
                        };
                    };
                    
                    port@1 {
                        reg = <1>;
                        chronos_csi_out: endpoint {
                            status = "okay";
                            remote-endpoint = <&chronos_vi_in>;
                        };
                    };
                };
            };
        };
    };
    
    /* NVCSI configuration */
    fragment@4 {
        target = <&nvcsi>;
        __overlay__ {
            status = "okay";
            
            channel@0 {
                reg = <0>;
                status = "okay";
                
                ports {
                    #address-cells = <1>;
                    #size-cells = <0>;
                    
                    port@0 {
                        reg = <0>;
                        chronos_nvcsi_in: endpoint {
                            status = "okay";
                            port-index = <0>;
                            bus-width = <2>;
                            remote-endpoint = <&chronos_csi_out>;
                            csi-port = <0>;
                            num-lanes = <2>;
                        };
                    };
                    
                    port@1 {
                        reg = <1>;
                        chronos_nvcsi_out: endpoint {
                            status = "okay";
                        };
                    };
                };
            };
        };
    };
    
    /* VI (Video Input) configuration */
    fragment@5 {
        target = <&vi>;
        __overlay__ {
            status = "okay";
            
            ports {
                #address-cells = <1>;
                #size-cells = <0>;
                
                port@0 {
                    reg = <0>;
                    chronos_vi_in: endpoint {
                        status = "okay";
                        port-index = <0>;
                        bus-width = <2>;
                        remote-endpoint = <&chronos_nvcsi_out>;
                    };
                };
            };
        };
    };
    
    /* Chronos platform device */
    fragment@6 {
        target-path = "/";
        __overlay__ {
            chronos_csi: chronos-multi-camera {
                compatible = "chronos,multi-camera-csi";
                status = "okay";
                
                clocks = <&bpmp TEGRA234_CLK_CSI>;
                clock-names = "csi";
                
                /* FPGA configuration I2C */
                fpga = <&chronos_fpga>;
                
                /* Number of virtual channels */
                num-cameras = <4>;
                
                /* Virtual channel mapping */
                vc-map = <0 1 2 3>;
                
                /* Frame format */
                width = <1280>;
                height = <800>;
                format = "Y10";
                
                /* DMA memory region */
                memory-region = <&chronos_reserved>;
            };
        };
    };
    
    /* Reserved memory for zero-copy DMA */
    fragment@7 {
        target-path = "/reserved-memory";
        __overlay__ {
            #address-cells = <2>;
            #size-cells = <2>;
            
            chronos_reserved: chronos-buffer@90000000 {
                compatible = "shared-dma-pool";
                reg = <0x0 0x90000000 0x0 0x10000000>;  /* 256MB */
                no-map;
                status = "okay";
            };
        };
    };
    
    /* Power supplies (adjust to match actual board design) */
    fragment@8 {
        target-path = "/";
        __overlay__ {
            vdd_cam_2v8: regulator-cam-2v8 {
                compatible = "regulator-fixed";
                regulator-name = "vdd_cam_2v8";
                regulator-min-microvolt = <2800000>;
                regulator-max-microvolt = <2800000>;
                regulator-always-on;
            };
            
            vdd_cam_1v8: regulator-cam-1v8 {
                compatible = "regulator-fixed";
                regulator-name = "vdd_cam_1v8";
                regulator-min-microvolt = <1800000>;
                regulator-max-microvolt = <1800000>;
                regulator-always-on;
            };
            
            vdd_cam_1v2: regulator-cam-1v2 {
                compatible = "regulator-fixed";
                regulator-name = "vdd_cam_1v2";
                regulator-min-microvolt = <1200000>;
                regulator-max-microvolt = <1200000>;
                regulator-always-on;
            };
        };
    };
    
    /* GPIO configuration for trigger signals */
    fragment@9 {
        target = <&gpio>;
        __overlay__ {
            chronos_pins: chronos-pins {
                gpio-hog;
                gpios = <TEGRA234_MAIN_GPIO(H, 3) GPIO_ACTIVE_LOW   /* CAM_RST */
                         TEGRA234_MAIN_GPIO(H, 6) GPIO_ACTIVE_HIGH>; /* IMU_INT */
                output-low;
                line-name = "chronos-gpio";
            };
        };
    };
};

/* Sensor mode table for tegra-camera-platform */
/ {
    fragment@10 {
        target-path = "/";
        __overlay__ {
            tegra-camera-platform {
                compatible = "nvidia,tegra-camera-platform";
                
                modules {
                    module0 {
                        badge = "chronos_ov9281_a";
                        position = "front";
                        orientation = "0";
                        
                        drivernode0 {
                            pcl_id = "v4l2_sensor";
                            sysfs-device-tree = "/sys/firmware/devicetree/base/i2c@31e0000/ov9281@60";
                        };
                    };
                };
            };
        };
    };
};
